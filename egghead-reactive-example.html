<!DOCTYPE html>
<html lang="en">
<head></head>
<style>
    .header, li {
        padding: 5px
    }

    body {
        font-family: sans-serif;
        padding: 10px
    }

    h3 {
        font-weight: 700;
        display: inline-block;
        padding: 0;
        margin: 0
    }

    .refresh {
        font-size: 80%;
        margin-left: 10px
    }

    .header {
        background: #ECECEC
    }

    .suggestions {
        border: 2px solid #ECECEC
    }

    li img {
        width: 40px;
        height: 40px;
        border-radius: 20px
    }

    li .close, li .username {
        display: inline-block;
        position: relative;
        bottom: 15px;
        left: 5px
    }
</style>
<body>
<div class="container">
    <div class="header">
        <h3>Who to follow</h3><a href="#" class="refresh">Refresh</a>
    </div>
    <ul class="suggestions">
        <li class="suggestion1">
            <img/>
            <a href="#" target="_blank" class="username">this will not be displayed</a>
            <a href="#" class="close close1">x</a>
        </li>
        <li class="suggestion2">
            <img/>
            <a href="#" target="_blank" class="username">neither this</a>
            <a href="#" class="close close2">x</a>
        </li>
        <li class="suggestion3">
            <img/>
            <a href="#" target="_blank" class="username">nor this</a>
            <a href="#" class="close close3">x</a>
        </li>
    </ul>
</div>

<script src="/bower_components/jquery/dist/jquery.min.js"></script>
<script src="/bower_components/rxjs/dist/rx.all.js"></script>
<script>
    var refreshButton = document.querySelector('.refresh');
    var closeButton1 = document.querySelector('.close1');
    var closeButton2 = document.querySelector('.close2');
    var closeButton3 = document.querySelector('.close3');

    var refreshClickStream = Rx.Observable.fromEvent(refreshButton, 'click');
    var close1Clicks = Rx.Observable.fromEvent(closeButton1, 'click');
    var close2Clicks = Rx.Observable.fromEvent(closeButton2, 'click');
    var close3Clicks = Rx.Observable.fromEvent(closeButton3, 'click');

    var startupRequestStream = Rx.Observable.just('https://api.github.com/users');

    var requestOnRefreshStream = refreshClickStream
            .map(function () {
                var randomOffset = Math.floor(Math.random() * 500);
                return 'https://api.github.com/users?since=' + randomOffset;
            });

    var requestStream = startupRequestStream.merge(requestOnRefreshStream);

    // shareReplay stops network requests on every "suggestionStream.subscribe" by converting
    // the stream into a hot observable and sharing the data
    var responseStream = requestStream
            .flatMap(function (requestUrl) {
                console.log('network request');
                return Rx.Observable.fromPromise(jQuery.getJSON(requestUrl));
            })
            .shareReplay(1);

    function getRandomUser(githubUsers) {
        return githubUsers[Math.floor(Math.random() * githubUsers.length)];
    }

    function createSuggestionStream(responseStream, closeClickStream) {
        return responseStream
                .map(getRandomUser)
                .startWith(null)
                .merge(refreshClickStream.map(function (evt) {
                    return null;
                }))
                .merge(closeClickStream.withLatestFrom(responseStream, function (clickEvt, githubUsers) {
                    return getRandomUser(githubUsers);
                }));
    }


    var suggestion1Stream = createSuggestionStream(responseStream, close1Clicks);
    var suggestion2Stream = createSuggestionStream(responseStream, close2Clicks);
    var suggestion3Stream = createSuggestionStream(responseStream, close3Clicks);

    suggestion1Stream.subscribe(function (user) {
        renderSuggestion(user, '.suggestion1');
    });

    suggestion2Stream.subscribe(function (user) {
        renderSuggestion(user, '.suggestion2');
    });

    suggestion3Stream.subscribe(function (user) {
        renderSuggestion(user, '.suggestion3');
    });


    // Rendering ---------------------------------------------------
    function renderSuggestion(suggestedUser, selector) {
        var suggestionEl = document.querySelector(selector);
        if (suggestedUser === null) {
            suggestionEl.style.visibility = 'hidden';
        } else {
            suggestionEl.style.visibility = 'visible';
            var usernameEl = suggestionEl.querySelector('.username');
            usernameEl.href = suggestedUser.html_url;
            usernameEl.textContent = suggestedUser.login;
            var imgEl = suggestionEl.querySelector('img');
            imgEl.src = "";
            imgEl.src = suggestedUser.avatar_url;
        }
    }


</script>
</body>
</html>